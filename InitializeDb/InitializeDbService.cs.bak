using System;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using Serilog;
using Serilog.Extensions.Logging;
using ApplicationCore.Domain.EN;
using ApplicationCore.Domain.CEN;
using ApplicationCore.Domain.CP;
using ApplicationCore.Domain.Repositories;
using ApplicationCore.Infrastructure.Memory;
using Infrastructure.NHibernate;
using Microsoft.Data.SqlClient;

public static class InitializeDbService
{
    // Returns 0 on success, non-zero on failure
    public static async Task<int> RunAsync(string[] args, TextWriter? externalLogWriter = null)
    {
        try
        {
            // Parse args similarly to previous Program.cs
            string mode = "inmemory";
            bool forceDrop = false;
            bool confirm = false;
            string dbName = "ProjectDatabase";
            bool doSeed = false;
            string? dataDirArg = null;
            bool verbose = false;
            string? logFile = null;
            string? targetConnection = null;
            string? targetDialect = null;
            foreach (var a in args)
            {
                if (a.StartsWith("--mode=", StringComparison.OrdinalIgnoreCase))
                {
                    mode = a.Substring("--mode=".Length).ToLowerInvariant();
                }
                else if (a.Equals("--force-drop", StringComparison.OrdinalIgnoreCase))
                {
                    forceDrop = true;
                }
                else if (a.Equals("--confirm", StringComparison.OrdinalIgnoreCase))
                {
                    confirm = true;
                }
                else if (a.StartsWith("--db-name=", StringComparison.OrdinalIgnoreCase))
                {
                    dbName = a.Substring("--db-name=".Length);
                    if (string.IsNullOrWhiteSpace(dbName)) dbName = "ProjectDatabase";
                }
                else if (a.Equals("--seed", StringComparison.OrdinalIgnoreCase))
                {
                    doSeed = true;
                }
                else if (a.StartsWith("--data-dir=", StringComparison.OrdinalIgnoreCase))
                {
                    dataDirArg = a.Substring("--data-dir=".Length);
                    if (string.IsNullOrWhiteSpace(dataDirArg)) dataDirArg = null;
                }
                else if (a.StartsWith("--target-connection=", StringComparison.OrdinalIgnoreCase))
                {
                    targetConnection = a.Substring("--target-connection=".Length);
                    if (string.IsNullOrWhiteSpace(targetConnection)) targetConnection = null;
                }
                else if (a.StartsWith("--dialect=", StringComparison.OrdinalIgnoreCase))
                {
                    targetDialect = a.Substring("--dialect=".Length);
                    if (string.IsNullOrWhiteSpace(targetDialect)) targetDialect = null;
                }
                else if (a.Equals("--verbose", StringComparison.OrdinalIgnoreCase) || a.Equals("-v", StringComparison.OrdinalIgnoreCase))
                {
                    verbose = true;
                }
                else if (a.StartsWith("--log-file=", StringComparison.OrdinalIgnoreCase))
                {
                    logFile = a.Substring("--log-file=".Length);
                    if (string.IsNullOrWhiteSpace(logFile)) logFile = null;
                }
            }

            if (mode == "schemaexport")
            {
                // Configure Serilog via centralized configurator (Infrastructure.Logging)
                async Task RetryAsync(Func<Task> work, int attempts = 3, int delayMs = 200)
                {
                    int tries = 0;
                    while (true)
                    {
                        try
                        {
                            await work();
                            return;
                        }
                        catch (Exception)
                        {
                            tries++;
                            if (tries >= attempts)
                            {
                                throw;
                            }
                            // small backoff
                            try { await Task.Delay(delayMs); } catch { }
                        }
                    }
                }

                try
                {
                    Infrastructure.Logging.SerilogConfigurator.Configure(logFile, verbose);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Failed to configure Serilog via SerilogConfigurator: {ex.Message}");
                    // Fallback to a minimal console logger
                    Log.Logger = new LoggerConfiguration().WriteTo.Console().CreateLogger();
                }
                using var loggerFactory = new SerilogLoggerFactory(Log.Logger, dispose: false);
                var logger = loggerFactory.CreateLogger("InitializeDb");

                // FileLog writes into the optional externalLogWriter (used by tests). Serilog handles console/file sinks.
                void FileLog(string line)
                {
                    try
                    {
                        if (externalLogWriter != null)
                        {
                            externalLogWriter.WriteLine(line);
                            externalLogWriter.Flush();
                        }
                    }
                    catch { }
                }

                // Resolve data directory
                string dataDir;
                if (!string.IsNullOrWhiteSpace(dataDirArg))
                {
                    dataDir = Path.GetFullPath(dataDirArg);
                }
                else
                {
                    var repoData = Path.GetFullPath(Path.Combine(AppContext.BaseDirectory, "..", "..", "..", "Data"));
                    dataDir = repoData;
                }
                Directory.CreateDirectory(dataDir);

                Console.WriteLine($"InitializeDb Run: mode={mode} logFile={logFile} externalLogWriterIsNull={externalLogWriter==null} verbose={verbose}");
                if (externalLogWriter != null)
                {
                    FileLog($"[{DateTime.UtcNow:o}] InitializeDb log started (external writer)");
                }

                logger.LogInformation("InitializeDb - running NHibernate SchemaExport mode...");
                FileLog($"[{DateTime.UtcNow:o}] InitializeDb started in schemaexport mode. dbName={dbName} verbose={verbose}");

                var mdfPath = Path.Combine(dataDir, dbName + ".mdf");
                string? lastConnectionString = null;
                string? lastDialect = null;
                try
                {
                    if (!string.IsNullOrWhiteSpace(targetConnection))
                    {
                        // Use the provided connection string and dialect directly instead of attempting LocalDB
                        var dialectToUse = string.IsNullOrWhiteSpace(targetDialect) ? "NHibernate.Dialect.MsSql2012Dialect" : targetDialect;
                        FileLog($"[{DateTime.UtcNow:o}] Exporting schema to target connection using connection: {targetConnection} dialect: {dialectToUse}");
                        Console.WriteLine($"Exporting schema to target connection: {targetConnection} dialect: {dialectToUse}");
                        // If targetting SQL Server, prefer to generate SQL script and run it via sqlcmd to avoid driver binding issues.
                        var driver = dialectToUse.Contains("MsSql", StringComparison.OrdinalIgnoreCase) ? "NHibernate.Driver.SqlClientDriver" : null;
                        var cfgForExport = NHibernateHelper.BuildConfiguration();
                        if (!string.IsNullOrWhiteSpace(dialectToUse)) cfgForExport.SetProperty("dialect", dialectToUse);
                        if (!string.IsNullOrWhiteSpace(driver)) cfgForExport.SetProperty("connection.driver_class", driver);
                        cfgForExport.SetProperty("connection.connection_string", targetConnection);

                        var schemaFile = Path.Combine(dataDir, dbName + "_schema.sql");
                        try
                        {
                            // Write DDL SQL to a file
                            var export = new NHibernate.Tool.hbm2ddl.SchemaExport(cfgForExport);
                            export.SetOutputFile(schemaFile);
                            export.Create(false, false);

                            // Parse target connection to get server and database for sqlcmd
                            var builder = new Microsoft.Data.SqlClient.SqlConnectionStringBuilder(targetConnection);
                            var server = builder.DataSource;
                            var database = builder.InitialCatalog ?? dbName;

                            // Execute the generated SQL script using sqlcmd (Windows)
                            var psi = new System.Diagnostics.ProcessStartInfo("sqlcmd", $"-S \"{server}\" -d \"{database}\" -E -i \"{schemaFile}\"") { RedirectStandardOutput = true, RedirectStandardError = true, UseShellExecute = false };
                            using var proc = System.Diagnostics.Process.Start(psi);
                            if (proc != null)
                            {
                                var outText = proc.StandardOutput.ReadToEnd();
                                var errText = proc.StandardError.ReadToEnd();
                                proc.WaitForExit(60000);
                                if (proc.ExitCode != 0)
                                {
                                    Console.WriteLine($"sqlcmd failed: {errText}");
                                    throw new InvalidOperationException($"sqlcmd failed: {errText}");
                                }
                            }
                            else
                            {
                                throw new InvalidOperationException("Failed to start sqlcmd process");
                            }

                            lastConnectionString = targetConnection;
                            lastDialect = dialectToUse;
                            logger.LogInformation("SchemaExport to target connection completed via sqlcmd.");
                            FileLog($"[{DateTime.UtcNow:o}] SchemaExport to target connection completed successfully via script {schemaFile}.");
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"SchemaExport to target connection failed: {ex.Message}");
                            throw;
                        }
                        lastConnectionString = targetConnection;
                        lastDialect = dialectToUse;
                        logger.LogInformation("SchemaExport to target connection completed.");
                        FileLog($"[{DateTime.UtcNow:o}] SchemaExport to target connection completed successfully.");
                    }
                    else
                    {
                        logger.LogInformation($"Attempting SchemaExport to LocalDB ({Path.GetFileName(mdfPath)})...");
                        FileLog($"[{DateTime.UtcNow:o}] Attempting SchemaExport to LocalDB ({mdfPath})");

                        if (File.Exists(mdfPath) && !forceDrop)
                        {
                            logger.LogWarning("LocalDB MDF already exists at {mdfPath} and --force-drop not provided. Skipping LocalDB attempt and falling back to SQLite.", mdfPath);
                            FileLog($"[{DateTime.UtcNow:o}] MDF exists and --force-drop not set. Skipping LocalDB.");
                            throw new InvalidOperationException("LocalDB MDF exists and force-drop not set.");
                        }

                        if (forceDrop && !confirm)
                        {
                            Console.WriteLine("--force-drop specified but --confirm not provided. Aborting destructive action. Falling back to SQLite.");
                            FileLog($"[{DateTime.UtcNow:o}] --force-drop without --confirm; aborting LocalDB destructive action.");
                            throw new InvalidOperationException("Force drop requested without confirm.");
                        }

                        using var masterConn = new SqlConnection("Data Source=(localdb)\\MSSQLLocalDB;Initial Catalog=master;Integrated Security=True;Connect Timeout=5;");
                        try
                        {
                            masterConn.Open();

                            if (forceDrop && confirm && File.Exists(mdfPath))
                            {
                                try
                                {
                                    var dropCmd = masterConn.CreateCommand();
                                    dropCmd.CommandText = $@"
IF EXISTS(SELECT name FROM sys.databases WHERE name = N'{dbName}')
BEGIN
    ALTER DATABASE [{dbName}] SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
    DROP DATABASE [{dbName}];
END
";
                                    dropCmd.ExecuteNonQuery();
                                }
                                catch (Exception dropEx)
                                {
                                    Console.WriteLine($"Failed to drop existing database '{dbName}': {dropEx.Message}. Will attempt file delete.");
                                    FileLog($"[{DateTime.UtcNow:o}] Failed to drop existing DB: {dropEx.Message}");
                                }

                                try
                                {
                                    Console.WriteLine($"Deleting existing MDF {mdfPath} as --force-drop and --confirm were provided...");
                                    await RetryAsync(() => { File.Delete(mdfPath); return Task.CompletedTask; }, attempts: 3, delayMs: 200);
                                    var logPath = Path.Combine(dataDir, dbName + "_log.ldf");
                                    if (File.Exists(logPath)) await RetryAsync(() => { File.Delete(logPath); return Task.CompletedTask; }, attempts: 3, delayMs: 200);
                                    Console.WriteLine("Existing MDF removed.");
                                }
                                catch (Exception delEx)
                                {
                                    Console.WriteLine($"Failed to delete existing MDF: {delEx.Message}. Falling back to SQLite.");
                                    FileLog($"[{DateTime.UtcNow:o}] Failed to delete existing MDF: {delEx.Message}");
                                    throw;
                                }
                            }

                            if (!File.Exists(mdfPath))
                            {
                                try
                                {
                                    var logPath = Path.Combine(dataDir, dbName + "_log.ldf");
                                    Console.WriteLine($"Creating LocalDB MDF at {mdfPath}...");
                                    var createCmd = masterConn.CreateCommand();
                                    createCmd.CommandText = $@"CREATE DATABASE [{dbName}] ON (NAME=N'{dbName}', FILENAME=N'{mdfPath}') LOG ON (NAME=N'{dbName}_log', FILENAME=N'{logPath}');";
                                    createCmd.ExecuteNonQuery();
                                    logger.LogInformation("LocalDB database created.");
                                }
                                catch (Exception createEx)
                                {
                                    Console.WriteLine($"Failed to create LocalDB MDF: {createEx.Message}");
                                    FileLog($"[{DateTime.UtcNow:o}] Failed to create LocalDB MDF: {createEx.Message}");
                                    throw;
                                }
                            }

                            var dbConn = $"Data Source=(localdb)\\MSSQLLocalDB;Initial Catalog={dbName};Integrated Security=True;Connect Timeout=30;";
                            FileLog($"[{DateTime.UtcNow:o}] Exporting schema to LocalDB using connection: {dbConn}");
                                    await RetryAsync(() => { NHibernateHelper.ExportSchema(dbConn, "NHibernate.Dialect.MsSql2012Dialect"); return Task.CompletedTask; }, attempts: 3, delayMs: 200);
                            lastConnectionString = dbConn;
                            lastDialect = "NHibernate.Dialect.MsSql2012Dialect";
                            logger.LogInformation("SchemaExport to LocalDB completed.");
                            FileLog($"[{DateTime.UtcNow:o}] SchemaExport to LocalDB completed successfully.");
                        }
                        catch (SqlException sqlEx)
                        {
                            Console.WriteLine($"LocalDB operations failed: {sqlEx.Message}");
                            throw;
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"LocalDB SchemaExport failed: {ex.Message}");
                    logger.LogWarning("Falling back to file-based SQLite SchemaExport...");
                    FileLog($"[{DateTime.UtcNow:o}] LocalDB SchemaExport failed: {ex.Message}. Falling back to SQLite.");
                    var sqlitePath = Path.Combine(dataDir, "project.db");
                    var sqliteConn = $"Data Source={sqlitePath};Version=3;";
                        try
                        {
                            FileLog($"[{DateTime.UtcNow:o}] Exporting schema to SQLite file at {sqlitePath}");
                            await RetryAsync(() => { NHibernateHelper.ExportSchema(sqliteConn, "NHibernate.Dialect.SQLiteDialect"); return Task.CompletedTask; }, attempts: 3, delayMs: 200);
                            lastConnectionString = sqliteConn;
                            lastDialect = "NHibernate.Dialect.SQLiteDialect";
                            logger.LogInformation("SchemaExport to SQLite file completed. Path={path}", sqlitePath);
                            FileLog($"[{DateTime.UtcNow:o}] SchemaExport to SQLite completed successfully. Path={sqlitePath}");
                        }
                        catch (Exception ex2)
                        {
                            Console.WriteLine($"SQLite SchemaExport also failed: {ex2.Message}");
                            FileLog($"[{DateTime.UtcNow:o}] SQLite SchemaExport failed: {ex2.Message}");
                            Console.WriteLine("InitializeDb schema export failed. Review NHibernate configuration and environment (LocalDB availability, file permissions).");
                            return 2;
                        }
                }

                logger.LogInformation("InitializeDb schema export finished.");
                FileLog($"[{DateTime.UtcNow:o}] InitializeDb schema export finished. connection={lastConnectionString} dialect={lastDialect}");

                if (doSeed)
                {
                    logger.LogInformation("Seeding database via NHibernate repositories (idempotent)...");
                    FileLog($"[{DateTime.UtcNow:o}] Starting idempotent seed. connection={lastConnectionString}");
                    try
                    {
                        if (string.IsNullOrWhiteSpace(lastConnectionString) || string.IsNullOrWhiteSpace(lastDialect))
                        {
                            Console.WriteLine("Warning: connection/dialect for seeding not available. Skipping seed.");
                        }
                        else
                        {
                            var services = new ServiceCollection();
                            var seedCfg = NHibernateHelper.BuildConfiguration();
                            seedCfg.SetProperty("connection.connection_string", lastConnectionString);
                            seedCfg.SetProperty("dialect", lastDialect);
                            if (!string.IsNullOrWhiteSpace(lastDialect) && lastDialect.Contains("MsSql", StringComparison.OrdinalIgnoreCase))
                            {
                                seedCfg.SetProperty("connection.driver_class", "NHibernate.Driver.SqlClientDriver");
                            }
                            var seedSf = seedCfg.BuildSessionFactory();

                            services.AddSingleton(seedSf);
                            services.AddScoped(provider => seedSf.OpenSession());

                            services.AddScoped<IUsuarioRepository, NHibernateUsuarioRepository>();
                            services.AddScoped<IRepository<Comunidad>, NHibernateComunidadRepository>();
                            services.AddScoped<IRepository<Equipo>, NHibernateEquipoRepository>();
                            services.AddScoped<IRepository<MiembroComunidad>, NHibernateMiembroComunidadRepository>();
                            // Register specialized repository interfaces so CENs can depend on them directly
                            services.AddScoped<IParticipacionTorneoRepository, NHibernateParticipacionTorneoRepository>();
                            services.AddScoped<IMiembroEquipoRepository, NHibernateMiembroEquipoRepository>();
                            services.AddScoped<IMiembroComunidadRepository, NHibernateMiembroComunidadRepository>();

                            services.AddScoped<IUnitOfWork, NHibernateUnitOfWork>();
                            services.AddScoped<UsuarioCEN>();
                            services.AddScoped<ComunidadCEN>();
                            services.AddScoped<EquipoCEN>();

                            var provider = services.BuildServiceProvider();
                            using var scope = provider.CreateScope();

                            var usuarioCEN = scope.ServiceProvider.GetRequiredService<UsuarioCEN>();
                            var comunidadCEN = scope.ServiceProvider.GetRequiredService<ComunidadCEN>();
                            var equipoCEN = scope.ServiceProvider.GetRequiredService<EquipoCEN>();
                            var uow = scope.ServiceProvider.GetRequiredService<IUnitOfWork>();

                            var usuarioRepo = scope.ServiceProvider.GetRequiredService<IUsuarioRepository>();
                            var comunidadRepo = scope.ServiceProvider.GetRequiredService<IRepository<Comunidad>>();
                            var equipoRepo = scope.ServiceProvider.GetRequiredService<IRepository<Equipo>>();
                            var miembroComunidadRepo = scope.ServiceProvider.GetRequiredService<IRepository<MiembroComunidad>>();

                            if (usuarioRepo.ReadByNick("alice") == null)
                            {
                                var u1 = usuarioCEN.NewUsuario("alice", "alice@example.com", PasswordHasher.Hash("password1"));
                                logger.LogInformation("Created user alice (id={id})", u1.IdUsuario);
                                FileLog($"[{DateTime.UtcNow:o}] Created user alice id={u1.IdUsuario}");
                            }
                            if (usuarioRepo.ReadByNick("bob") == null)
                            {
                                var u2 = usuarioCEN.NewUsuario("bob", "bob@example.com", PasswordHasher.Hash("password2"));
                                logger.LogInformation("Created user bob (id={id})", u2.IdUsuario);
                                FileLog($"[{DateTime.UtcNow:o}] Created user bob id={u2.IdUsuario}");
                            }

                            if (!comunidadRepo.ReadFilter("Gamers").Any())
                            {
                                var com = comunidadCEN.NewComunidad("Gamers", "Comunidad de prueba");
                                logger.LogInformation("Created comunidad {id}", com.IdComunidad);
                                FileLog($"[{DateTime.UtcNow:o}] Created comunidad id={com.IdComunidad}");
                            }
                            if (!equipoRepo.ReadFilter("TeamA").Any())
                            {
                                var eq = equipoCEN.NewEquipo("TeamA", "Equipo de ejemplo");
                                logger.LogInformation("Created equipo {id}", eq.IdEquipo);
                                FileLog($"[{DateTime.UtcNow:o}] Created equipo id={eq.IdEquipo}");
                            }

                            var existingCom = comunidadRepo.ReadFilter("Gamers").FirstOrDefault();
                            var existingUser = usuarioRepo.ReadByNick("alice");
                            if (existingCom != null && existingUser != null && !miembroComunidadRepo.ReadFilter(existingUser.Nick ?? "").Any())
                            {
                                var mc = new MiembroComunidad { Usuario = existingUser, Comunidad = existingCom, FechaAlta = DateTime.UtcNow, Rol = ApplicationCore.Domain.Enums.RolComunidad.MIEMBRO };
                                miembroComunidadRepo.New(mc);
                                Console.WriteLine($"Created MiembroComunidad for user {existingUser.Nick}");
                                FileLog($"[{DateTime.UtcNow:o}] Created MiembroComunidad user={existingUser.Nick} comunidad={existingCom.Nombre}");
                            }

                            uow.SaveChanges();
                            Console.WriteLine("Seeding completed.");
                            FileLog($"[{DateTime.UtcNow:o}] Seeding completed and changes saved.");

                            try { seedSf.Dispose(); FileLog($"[{DateTime.UtcNow:o}] Seed SessionFactory disposed."); } catch { }
                        }
                    }
                    catch (Exception seedEx)
                    {
                        Console.WriteLine($"Seeding failed: {seedEx.Message}");
                        FileLog($"[{DateTime.UtcNow:o}] Seeding failed: {seedEx.Message}");
                        return 3;
                    }
                }

                try
                {
                    // Flush and close Serilog so file sinks are written to disk
                    Log.Information("[{time}] InitializeDb completed", DateTime.UtcNow.ToString("o"));
                    Log.CloseAndFlush();
                }
                catch { }

                return 0;
            }
            else
            {
                // In-memory validation path (kept for completeness)
                Console.WriteLine("InitializeDb - running in-memory validation (extended with comprehensive entity creation and method invocations)...");

                // Create repositories (use specialized where available)
                var usuarioRepo = new InMemoryUsuarioRepository();
                var comunidadRepo = new InMemoryRepository<Comunidad>();
                var equipoRepo = new InMemoryRepository<Equipo>();
                var publicacionRepo = new InMemoryRepository<Publicacion>();
                var comentarioRepo = new InMemoryRepository<Comentario>();
                var reaccionRepo = new InMemoryRepository<Reaccion>();
                var perfilRepo = new InMemoryRepository<Perfil>();
                var juegoRepo = new InMemoryRepository<Juego>();
                var torneoRepo = new InMemoryRepository<Torneo>();
                var propuestaRepo = new ApplicationCore.Infrastructure.Memory.InMemoryPropuestaTorneoRepository();
                var participacionRepo = new ApplicationCore.Infrastructure.Memory.InMemoryParticipacionTorneoRepository();
                var miembroComunidadRepo = new ApplicationCore.Infrastructure.Memory.InMemoryMiembroComunidadRepository();
                var miembroEquipoRepo = new ApplicationCore.Infrastructure.Memory.InMemoryMiembroEquipoRepository();
                var invitacionRepo = new ApplicationCore.Infrastructure.Memory.InMemoryRepository<Invitacion>();
                var chatEquipoRepo = new InMemoryRepository<ChatEquipo>();
                var mensajeChatRepo = new InMemoryRepository<MensajeChat>();
                var notRepo = new InMemoryRepository<Notificacion>();
                var perfilJuegoRepo = new InMemoryRepository<PerfilJuego>();
                var sesionRepo = new InMemoryRepository<Sesion>();
                var solicitudRepo = new InMemoryRepository<SolicitudIngreso>();
                var votoRepo = new InMemoryRepository<VotoTorneo>();

                var uow = new InMemoryUnitOfWork();

                // Instantiate ALL CENs (business logic) with in-memory repos
                var usuarioCEN = new UsuarioCEN(usuarioRepo);
                var authCEN = new AuthenticationCEN(usuarioRepo);
                var comunidadCEN = new ComunidadCEN(comunidadRepo);
                var equipoCEN = new EquipoCEN(equipoRepo);
                var publicacionCEN = new PublicacionCEN(publicacionRepo);
                var comentarioCEN = new ComentarioCEN(comentarioRepo);
                var reaccionCEN = new ReaccionCEN(reaccionRepo);
                var perfilCEN = new PerfilCEN(perfilRepo);
                var juegoCEN = new JuegoCEN(juegoRepo);
                var propuestaCEN = new PropuestaTorneoCEN(propuestaRepo);
                var miembroComunidadCEN = new MiembroComunidadCEN(miembroComunidadRepo);
                var miembroEquipoCEN = new MiembroEquipoCEN(miembroEquipoRepo);
                var chatEquipoCEN = new ChatEquipoCEN(chatEquipoRepo);
                var invitacionCEN = new InvitacionCEN(invitacionRepo);
                var mensajeChatCEN = new MensajeChatCEN(mensajeChatRepo);
                var notificacionCEN = new NotificacionCEN(notRepo);
                var participacionCEN = new ParticipacionTorneoCEN(participacionRepo);
                var perfilJuegoCEN = new PerfilJuegoCEN(perfilJuegoRepo);
                var sesionCEN = new SesionCEN(sesionRepo);
                var solicitudCEN = new SolicitudIngresoCEN(solicitudRepo);
                var votoCEN = new VotoTorneoCEN(votoRepo);

                // Instantiate ALL CPs (use cases)
                var crearComunidadCP = new CrearComunidadCP(comunidadRepo, uow);
                var unirEquipoCP = new UnirEquipoCP(miembroEquipoRepo, usuarioRepo, notRepo, uow);
                var aceptarInvitacionCP = new AceptarInvitacionCP(invitacionRepo, miembroEquipoRepo, uow);
                var aprobarPropuestaTorneoCP = new AprobarPropuestaTorneoCP(propuestaRepo, participacionRepo, uow);

                Console.WriteLine("\n=== CREANDO ENTIDADES Y EJERCITANDO TODOS LOS METODOS DE LOGICA DE NEGOCIO ===\n");

                // ====== USUARIOS & AUTENTICACION ======
                Console.WriteLine("--- UsuarioCEN y AuthenticationCEN ---");
                var u1 = usuarioCEN.NewUsuario("alice", "alice@example.com", PasswordHasher.Hash("password1"));
                var u2 = usuarioCEN.NewUsuario("bob", "bob@example.com", PasswordHasher.Hash("password2"));
                var u3 = usuarioCEN.NewUsuario("charlie", "charlie@example.com", PasswordHasher.Hash("password3"));
                Console.WriteLine($"Usuarios creados: {u1.IdUsuario}={u1.Nick}, {u2.IdUsuario}={u2.Nick}, {u3.IdUsuario}={u3.Nick}");
                
                var allUsers = usuarioCEN.ReadAll_Usuario();
                Console.WriteLine($"ReadAll_Usuario: {allUsers.Count()} usuarios");
                var userById = usuarioCEN.ReadOID_Usuario(u1.IdUsuario);
                Console.WriteLine($"ReadOID_Usuario(alice): {userById?.Nick}");
                var userByNick = usuarioCEN.ReadByNick("bob");
                Console.WriteLine($"ReadByNick(bob): {userByNick?.Nick}");
                u1.Email = "alice_new@example.com";
                usuarioCEN.ModifyUsuario(u1);
                Console.WriteLine($"ModifyUsuario(alice): email actualizado a {u1.Email}");
                
                var loginOk = authCEN.Login("alice", "password1");
                Console.WriteLine($"AuthenticationCEN.Login(alice, password1): {(loginOk != null ? "OK" : "FAIL")}");
                var loginFail = authCEN.Login("alice", "wrongpass");
                Console.WriteLine($"AuthenticationCEN.Login(alice, wrongpass): {(loginFail != null ? "OK" : "FAIL")}");

                // ====== COMUNIDAD ======
                Console.WriteLine("\n--- ComunidadCEN ---");
                var com1 = comunidadCEN.NewComunidad("Gamers", "Comunidad de jugadores");
                var com2 = comunidadCEN.NewComunidad("Developers", "Comunidad de desarrolladores");
                Console.WriteLine($"Comunidades creadas: {com1.IdComunidad}={com1.Nombre}, {com2.IdComunidad}={com2.Nombre}");
                
                var allComs = comunidadCEN.ReadAll_Comunidad();
                Console.WriteLine($"ReadAll_Comunidad: {allComs.Count()} comunidades");
                var comFilter = comunidadCEN.ReadFilter_Comunidad("Gamers");
                Console.WriteLine($"ReadFilter_Comunidad('Gamers'): {comFilter.Count()} resultados");
                var comById = comunidadCEN.ReadOID_Comunidad(com1.IdComunidad);
                Console.WriteLine($"ReadOID_Comunidad: {comById?.Nombre}");
                com1.Descripcion = "Descripcion modificada de Gamers";
                comunidadCEN.ModifyComunidad(com1);
                Console.WriteLine($"ModifyComunidad: descripcion actualizada");

                // ====== EQUIPO ======
                Console.WriteLine("\n--- EquipoCEN ---");
                var eq1 = equipoCEN.NewEquipo("TeamAlpha", "Equipo Alpha");
                var eq2 = equipoCEN.NewEquipo("TeamBeta", "Equipo Beta");
                Console.WriteLine($"Equipos creados: {eq1.IdEquipo}={eq1.Nombre}, {eq2.IdEquipo}={eq2.Nombre}");
                
                var allEqs = equipoCEN.ReadAll_Equipo();
                Console.WriteLine($"ReadAll_Equipo: {allEqs.Count()} equipos");
                var eqFilter = equipoCEN.ReadFilter_Equipo("Alpha");
                Console.WriteLine($"ReadFilter_Equipo('Alpha'): {eqFilter.Count()} resultados");
                var eqById = equipoCEN.ReadOID_Equipo(eq1.IdEquipo);
                Console.WriteLine($"ReadOID_Equipo: {eqById?.Nombre}");
                eq1.Descripcion = "Descripcion modificada de Alpha";
                equipoCEN.ModifyEquipo(eq1);
                Console.WriteLine($"ModifyEquipo: descripcion actualizada");

                // ====== CHATEQUIPO ======
                Console.WriteLine("\n--- ChatEquipoCEN ---");
                var chat1 = chatEquipoCEN.NewChatEquipo(eq1);
                var chat2 = chatEquipoCEN.NewChatEquipo(eq2);
                Console.WriteLine($"Chats creados: {chat1.IdChatEquipo}, {chat2.IdChatEquipo}");
                
                var allChats = chatEquipoCEN.ReadAll_ChatEquipo();
                Console.WriteLine($"ReadAll_ChatEquipo: {allChats.Count()} chats");
                var chatById = chatEquipoCEN.ReadOID_ChatEquipo(chat1.IdChatEquipo);
                Console.WriteLine($"ReadOID_ChatEquipo: {chatById?.IdChatEquipo}");
                chatEquipoCEN.ModifyChatEquipo(chat1);
                Console.WriteLine($"ModifyChatEquipo: modificado");

                // ====== PUBLICACION ======
                Console.WriteLine("\n--- PublicacionCEN ---");
                var pub1 = publicacionCEN.NewPublicacion("Primera publicacion", com1, u1);
                var pub2 = publicacionCEN.NewPublicacion("Segunda publicacion", null, u2);
                Console.WriteLine($"Publicaciones creadas: {pub1.IdPublicacion}, {pub2.IdPublicacion}");
                
                var allPubs = publicacionCEN.ReadAll_Publicacion();
                Console.WriteLine($"ReadAll_Publicacion: {allPubs.Count()} publicaciones");
                var pubFilter = publicacionCEN.ReadFilter_Publicacion("Primera");
                Console.WriteLine($"ReadFilter_Publicacion('Primera'): {pubFilter.Count()} resultados");
                var pubById = publicacionCEN.ReadOID_Publicacion(pub1.IdPublicacion);
                Console.WriteLine($"ReadOID_Publicacion: {pubById?.Contenido}");
                pub1.Contenido = "Contenido modificado";
                publicacionCEN.ModifyPublicacion(pub1);
                Console.WriteLine($"ModifyPublicacion: contenido actualizado");
                
                // Metodo custom: AddComentario
                var comentarioAdded = publicacionCEN.AddComentario(pub1, u2, "Comentario desde metodo custom AddComentario");
                Console.WriteLine($"AddComentario (custom): comentario agregado con contenido '{comentarioAdded.Contenido}'");

                // ====== COMENTARIO ======
                Console.WriteLine("\n--- ComentarioCEN ---");
                var com_c1 = comentarioCEN.NewComentario("Buen post!", u2, pub1);
                var com_c2 = comentarioCEN.NewComentario("Excelente!", u3, pub2);
                Console.WriteLine($"Comentarios creados: {com_c1.IdComentario}, {com_c2.IdComentario}");
                
                var allComs_c = comentarioCEN.ReadAll_Comentario();
                Console.WriteLine($"ReadAll_Comentario: {allComs_c.Count()} comentarios");
                var comFilter_c = comentarioCEN.ReadFilter_Comentario("Buen");
                Console.WriteLine($"ReadFilter_Comentario('Buen'): {comFilter_c.Count()} resultados");
                var comById_c = comentarioCEN.ReadOID_Comentario(com_c1.IdComentario);
                Console.WriteLine($"ReadOID_Comentario: {comById_c?.Contenido}");
                com_c1.Contenido = "Contenido modificado del comentario";
                comentarioCEN.ModifyComentario(com_c1);
                Console.WriteLine($"ModifyComentario: contenido actualizado");

                // ====== REACCION ======
                Console.WriteLine("\n--- ReaccionCEN ---");
                var reac1 = reaccionCEN.NewReaccion(true, u1, pub1);
                var reac2 = reaccionCEN.NewReaccion(false, u2, pub2);
                Console.WriteLine($"Reacciones creadas: {reac1.IdReaccion} (megusta={reac1.MeGusta}), {reac2.IdReaccion} (megusta={reac2.MeGusta})");
                
                var allReacs = reaccionCEN.ReadAll_Reaccion();
                Console.WriteLine($"ReadAll_Reaccion: {allReacs.Count()} reacciones");
                var reacFilter = reaccionCEN.ReadFilter_Reaccion("true");
                Console.WriteLine($"ReadFilter_Reaccion('true'): {reacFilter.Count()} resultados");
                var reacById = reaccionCEN.ReadOID_Reaccion(reac1.IdReaccion);
                Console.WriteLine($"ReadOID_Reaccion: {reacById?.MeGusta}");
                reac1.MeGusta = false;
                reaccionCEN.ModifyReaccion(reac1);
                Console.WriteLine($"ModifyReaccion: megusta cambiado a {reac1.MeGusta}");

                // ====== PERFIL ======
                Console.WriteLine("\n--- PerfilCEN ---");
                var perfil1 = perfilCEN.NewPerfil("Bio de alice - jugadora profesional", u1);
                var perfil2 = perfilCEN.NewPerfil("Bio de bob - desarrollador indie", u2);
                Console.WriteLine($"Perfiles creados: {perfil1.IdPerfil}, {perfil2.IdPerfil}");
                
                var allPerfiles = perfilCEN.ReadAll_Perfil();
                Console.WriteLine($"ReadAll_Perfil: {allPerfiles.Count()} perfiles");
                var perfilFilter = perfilCEN.ReadFilter_Perfil("alice");
                Console.WriteLine($"ReadFilter_Perfil('alice'): {perfilFilter.Count()} resultados");
                var perfilById = perfilCEN.ReadOID_Perfil(perfil1.IdPerfil);
                Console.WriteLine($"ReadOID_Perfil: {perfilById?.Biografia}");
                perfil1.Biografia = "Biografia actualizada de alice";
                perfilCEN.ModifyPerfil(perfil1);
                Console.WriteLine($"ModifyPerfil: biografia actualizada");

                // ====== JUEGO ======
                Console.WriteLine("\n--- JuegoCEN ---");
                var juego1 = juegoCEN.NewJuego("The Legend of Zelda", ApplicationCore.Domain.Enums.GeneroJuego.AVENTURA);
                var juego2 = juegoCEN.NewJuego("Counter Strike", ApplicationCore.Domain.Enums.GeneroJuego.ACCION);
                var juego3 = juegoCEN.NewJuego("FIFA 24", ApplicationCore.Domain.Enums.GeneroJuego.DEPORTES);
                Console.WriteLine($"Juegos creados: {juego1.IdJuego}={juego1.Nombre}, {juego2.IdJuego}={juego2.Nombre}, {juego3.IdJuego}={juego3.Nombre}");
                
                var allJuegos = juegoCEN.ReadAll_Juego();
                Console.WriteLine($"ReadAll_Juego: {allJuegos.Count()} juegos");
                var juegoFilter = juegoCEN.ReadFilter_Juego("Zelda");
                Console.WriteLine($"ReadFilter_Juego('Zelda'): {juegoFilter.Count()} resultados");
                var juegoById = juegoCEN.ReadOID_Juego(juego1.IdJuego);
                Console.WriteLine($"ReadOID_Juego: {juegoById?.Nombre}");
                juego1.Nombre = "The Legend of Zelda: Breath of the Wild";
                juegoCEN.ModifyJuego(juego1);
                Console.WriteLine($"ModifyJuego: nombre actualizado a {juego1.Nombre}");

                // ====== PERFILJUEGO ======
                Console.WriteLine("\n--- PerfilJuegoCEN ---");
                var perfilJuego1 = perfilJuegoCEN.NewPerfilJuego(perfil1, juego1);
                var perfilJuego2 = perfilJuegoCEN.NewPerfilJuego(perfil2, juego2);
                Console.WriteLine($"PerfilJuegos creados: {perfilJuego1.IdPerfilJuego}, {perfilJuego2.IdPerfilJuego}");
                
                var allPerfilJuegos = perfilJuegoCEN.ReadAll_PerfilJuego();
                Console.WriteLine($"ReadAll_PerfilJuego: {allPerfilJuegos.Count()} perfil-juegos");
                var perfilJuegoFilter = perfilJuegoCEN.ReadFilter_PerfilJuego("Zelda");
                Console.WriteLine($"ReadFilter_PerfilJuego('Zelda'): {perfilJuegoFilter.Count()} resultados");
                var perfilJuegoById = perfilJuegoCEN.ReadOID_PerfilJuego(perfilJuego1.IdPerfilJuego);
                Console.WriteLine($"ReadOID_PerfilJuego: {perfilJuegoById?.IdPerfilJuego}");
                perfilJuegoCEN.ModifyPerfilJuego(perfilJuego1);
                Console.WriteLine($"ModifyPerfilJuego: modificado");

                // ====== TORNEO ======
                Console.WriteLine("\n--- Torneo (creacion directa - sin CEN) ---");
                var torneo1 = new Torneo { Nombre = "Torneo de Verano 2025", FechaInicio = DateTime.UtcNow.AddDays(30), Estado = "PENDIENTE", ComunidadOrganizadora = com1 };
                torneoRepo.New(torneo1);
                var torneo2 = new Torneo { Nombre = "Copa de Invierno 2025", FechaInicio = DateTime.UtcNow.AddDays(60), Estado = "PENDIENTE", ComunidadOrganizadora = com2 };
                torneoRepo.New(torneo2);
                Console.WriteLine($"Torneos creados: {torneo1.IdTorneo}={torneo1.Nombre}, {torneo2.IdTorneo}={torneo2.Nombre}");
                
                var allTorneos = torneoRepo.ReadAll();
                Console.WriteLine($"ReadAll torneos: {allTorneos.Count()} torneos");
                var torneoFilter = torneoRepo.ReadFilter("Verano");
                Console.WriteLine($"ReadFilter torneos ('Verano'): {torneoFilter.Count()} resultados");
                var torneoById = torneoRepo.ReadById(torneo1.IdTorneo);
                Console.WriteLine($"ReadById torneo: {torneoById?.Nombre}");
                torneo1.Nombre = "Gran Torneo de Verano 2025";
                torneoRepo.Modify(torneo1);
                Console.WriteLine($"Modify torneo: nombre actualizado a {torneo1.Nombre}");

                // ====== PROPUESTATORNEO ======
                Console.WriteLine("\n--- PropuestaTorneoCEN ---");
                var propuesta1 = propuestaCEN.NewPropuestaTorneo(eq1, torneo1, u1);
                var propuesta2 = propuestaCEN.NewPropuestaTorneo(eq2, torneo2, u2);
                Console.WriteLine($"Propuestas creadas: {propuesta1.IdPropuestaTorneo}, {propuesta2.IdPropuestaTorneo}");
                
                var allPropuestas = propuestaCEN.ReadAll_PropuestaTorneo();
                Console.WriteLine($"ReadAll_PropuestaTorneo: {allPropuestas.Count()} propuestas");
                var propuestaFilter = propuestaCEN.ReadFilter_PropuestaTorneo("PENDIENTE");
                Console.WriteLine($"ReadFilter_PropuestaTorneo('PENDIENTE'): {propuestaFilter.Count()} resultados");
                var propuestaById = propuestaCEN.ReadOID_PropuestaTorneo(propuesta1.IdPropuestaTorneo);
                Console.WriteLine($"ReadOID_PropuestaTorneo: {propuestaById?.Estado}");
                propuesta1.Estado = ApplicationCore.Domain.Enums.EstadoSolicitud.EN_REVISION;
                propuestaCEN.ModifyPropuestaTorneo(propuesta1);
                Console.WriteLine($"ModifyPropuestaTorneo: estado actualizado a {propuesta1.Estado}");
                
                // Metodo custom: AprobarSiVotosUnanimes
                var voto1 = votoCEN.NewVotoTorneo(propuesta1, u1, true);
                var voto2 = votoCEN.NewVotoTorneo(propuesta1, u2, true);
                var aprobada = propuestaCEN.AprobarSiVotosUnanimes(propuesta1);
                Console.WriteLine($"AprobarSiVotosUnanimes (custom): {(aprobada ? "APROBADA" : "NO APROBADA")}");

                // ====== PARTICIPACIONTORNEO ======
                Console.WriteLine("\n--- ParticipacionTorneoCEN ---");
                var participacion1 = participacionCEN.NewParticipacionTorneo(eq1, torneo1);
                var participacion2 = participacionCEN.NewParticipacionTorneo(eq2, torneo2);
                Console.WriteLine($"Participaciones creadas: {participacion1.IdParticipacionTorneo}, {participacion2.IdParticipacionTorneo}");
                
                var allParticipaciones = participacionCEN.ReadAll_ParticipacionTorneo();
                Console.WriteLine($"ReadAll_ParticipacionTorneo: {allParticipaciones.Count()} participaciones");
                var participacionFilter = participacionCEN.ReadFilter_ParticipacionTorneo("PENDIENTE");
                Console.WriteLine($"ReadFilter_ParticipacionTorneo('PENDIENTE'): {participacionFilter.Count()} resultados");
                var participacionById = participacionCEN.ReadOID_ParticipacionTorneo(participacion1.IdParticipacionTorneo);
                Console.WriteLine($"ReadOID_ParticipacionTorneo: {participacionById?.Estado}");
                participacion1.Estado = ApplicationCore.Domain.Enums.EstadoParticipacion.ACEPTADA.ToString();
                participacionCEN.ModifyParticipacionTorneo(participacion1);
                Console.WriteLine($"ModifyParticipacionTorneo: estado actualizado");
                
                // Metodos custom (filtros)
                var equiposByTorneo = participacionCEN.ReadFilter_EquiposByTorneo(torneo1.IdTorneo);
                Console.WriteLine($"ReadFilter_EquiposByTorneo (custom filter): {equiposByTorneo.Count()} equipos en torneo1");
                var torneosByEquipo = participacionCEN.ReadFilter_TorneosByEquipo(eq1.IdEquipo);
                Console.WriteLine($"ReadFilter_TorneosByEquipo (custom filter): {torneosByEquipo.Count()} torneos para eq1");

                // ====== VOTOTORNEO ======
                Console.WriteLine("\n--- VotoTorneoCEN ---");
                var voto3 = votoCEN.NewVotoTorneo(propuesta2, u3, false);
                Console.WriteLine($"Votos creados: {voto1.IdVotoTorneo}, {voto2.IdVotoTorneo}, {voto3.IdVotoTorneo}");
                
                var allVotos = votoCEN.ReadAll_VotoTorneo();
                Console.WriteLine($"ReadAll_VotoTorneo: {allVotos.Count()} votos");
                var votoFilter = votoCEN.ReadFilter_VotoTorneo("true");
                Console.WriteLine($"ReadFilter_VotoTorneo('true'): {votoFilter.Count()} resultados");
                var votoById = votoCEN.ReadOID_VotoTorneo(voto1.IdVotoTorneo);
                Console.WriteLine($"ReadOID_VotoTorneo: {votoById?.Valor}");
                voto3.Valor = true;
                votoCEN.ModifyVotoTorneo(voto3);
                Console.WriteLine($"ModifyVotoTorneo: valor actualizado a {voto3.Valor}");

                // ====== MIEMBROCOMUNIDAD ======
                Console.WriteLine("\n--- MiembroComunidadCEN ---");
                var miembroCom1 = miembroComunidadCEN.NewMiembroComunidad(u1, com1, ApplicationCore.Domain.Enums.RolComunidad.MIEMBRO);
                var miembroCom2 = miembroComunidadCEN.NewMiembroComunidad(u2, com1, ApplicationCore.Domain.Enums.RolComunidad.MODERADOR);
                var miembroCom3 = miembroComunidadCEN.NewMiembroComunidad(u3, com2, ApplicationCore.Domain.Enums.RolComunidad.MIEMBRO);
                Console.WriteLine($"MiembrosComunidad creados: {miembroCom1.IdMiembroComunidad}, {miembroCom2.IdMiembroComunidad}, {miembroCom3.IdMiembroComunidad}");
                
                var allMiembrosCom = miembroComunidadCEN.ReadAll_MiembroComunidad();
                Console.WriteLine($"ReadAll_MiembroComunidad: {allMiembrosCom.Count()} miembros");
                var miembroComById = miembroComunidadCEN.ReadOID_MiembroComunidad(miembroCom1.IdMiembroComunidad);
                Console.WriteLine($"ReadOID_MiembroComunidad: {miembroComById?.Usuario?.Nick} en {miembroComById?.Comunidad?.Nombre}");
                miembroCom1.Rol = ApplicationCore.Domain.Enums.RolComunidad.ADMINISTRADOR;
                miembroComunidadCEN.ModifyMiembroComunidad(miembroCom1);
                Console.WriteLine($"ModifyMiembroComunidad: rol actualizado a {miembroCom1.Rol}");
                
                // Metodos custom
                miembroComunidadCEN.PromocionarAModerador(miembroCom3);
                Console.WriteLine($"PromocionarAModerador (custom): miembroCom3 promovido a {miembroCom3.Rol}");
                miembroComunidadCEN.ActualizarFechaAccion(miembroCom1);
                Console.WriteLine($"ActualizarFechaAccion (custom): fecha actualizada");
                miembroComunidadCEN.CambiarRol(miembroCom2, ApplicationCore.Domain.Enums.RolComunidad.ADMINISTRADOR);
                Console.WriteLine($"CambiarRol (custom): miembroCom2 cambiado a {miembroCom2.Rol}");
                
                var usuariosByComunidad = miembroComunidadCEN.ReadFilter_UsuariosByComunidadMembership(com1.IdComunidad);
                Console.WriteLine($"ReadFilter_UsuariosByComunidadMembership (custom filter): {usuariosByComunidad.Count()} usuarios en com1");

                // ====== MIEMBROEQUIPO ======
                Console.WriteLine("\n--- MiembroEquipoCEN ---");
                var miembroEq1 = miembroEquipoCEN.NewMiembroEquipo(u1, eq1, ApplicationCore.Domain.Enums.RolEquipo.CAPITAN);
                var miembroEq2 = miembroEquipoCEN.NewMiembroEquipo(u2, eq1, ApplicationCore.Domain.Enums.RolEquipo.MIEMBRO);
                var miembroEq3 = miembroEquipoCEN.NewMiembroEquipo(u3, eq2, ApplicationCore.Domain.Enums.RolEquipo.MIEMBRO);
                Console.WriteLine($"MiembrosEquipo creados: {miembroEq1.IdMiembroEquipo}, {miembroEq2.IdMiembroEquipo}, {miembroEq3.IdMiembroEquipo}");
                
                var allMiembrosEq = miembroEquipoCEN.ReadAll_MiembroEquipo();
                Console.WriteLine($"ReadAll_MiembroEquipo: {allMiembrosEq.Count()} miembros");
                var miembroEqFilter = miembroEquipoCEN.ReadFilter_MiembroEquipo("ACTIVA");
                Console.WriteLine($"ReadFilter_MiembroEquipo('ACTIVA'): {miembroEqFilter.Count()} resultados");
                var miembroEqById = miembroEquipoCEN.ReadOID_MiembroEquipo(miembroEq1.IdMiembroEquipo);
                Console.WriteLine($"ReadOID_MiembroEquipo: {miembroEqById?.Usuario?.Nick} en {miembroEqById?.Equipo?.Nombre}");
                miembroEq2.Rol = ApplicationCore.Domain.Enums.RolEquipo.VICECAPITAN;
                miembroEquipoCEN.ModifyMiembroEquipo(miembroEq2);
                Console.WriteLine($"ModifyMiembroEquipo: rol actualizado a {miembroEq2.Rol}");
                
                // Metodos custom
                miembroEquipoCEN.ActualizarFechaAccion(miembroEq1);
                Console.WriteLine($"ActualizarFechaAccion (custom): fecha actualizada");
                var usuariosByEquipo = miembroEquipoCEN.ReadFilter_UsuariosByEquipoMembership(eq1.IdEquipo);
                Console.WriteLine($"ReadFilter_UsuariosByEquipoMembership (custom filter): {usuariosByEquipo.Count()} usuarios en eq1");

                // ====== INVITACION ======
                Console.WriteLine("\n--- InvitacionCEN ---");
                var inv1 = invitacionCEN.NewInvitacion(u1, com1, "Te invito a unirte a Gamers");
                var inv2 = invitacionCEN.NewInvitacion(u2, com2, "Unete a Developers");
                // Invitacion a equipo
                inv1.Tipo = ApplicationCore.Domain.Enums.TipoInvitacion.EQUIPO;
                inv1.Equipo = eq1;
                inv1.Comunidad = null;
                Console.WriteLine($"Invitaciones creadas: {inv1.IdInvitacion}, {inv2.IdInvitacion}");
                
                var allInvs = invitacionCEN.ReadAll_Invitacion();
                Console.WriteLine($"ReadAll_Invitacion: {allInvs.Count()} invitaciones");
                var invFilter = invitacionCEN.ReadFilter_Invitacion("PENDIENTE");
                Console.WriteLine($"ReadFilter_Invitacion('PENDIENTE'): {invFilter.Count()} resultados");
                var invById = invitacionCEN.ReadOID_Invitacion(inv1.IdInvitacion);
                Console.WriteLine($"ReadOID_Invitacion: {invById?.Mensaje}");
                inv2.Estado = ApplicationCore.Domain.Enums.EstadoSolicitud.RECHAZADA;
                invitacionCEN.ModifyInvitacion(inv2);
                Console.WriteLine($"ModifyInvitacion: estado actualizado a {inv2.Estado}");

                // ====== MENSAJECHAT ======
                Console.WriteLine("\n--- MensajeChatCEN ---");
                var msg1 = mensajeChatCEN.NewMensajeChat(u1, "Hola equipo!", chat1);
                var msg2 = mensajeChatCEN.NewMensajeChat(u2, "Como estan?", chat1);
                Console.WriteLine($"MensajesChat creados: {msg1.IdMensajeChat}, {msg2.IdMensajeChat}");
                
                var allMsgs = mensajeChatCEN.ReadAll_MensajeChat();
                Console.WriteLine($"ReadAll_MensajeChat: {allMsgs.Count()} mensajes");
                var msgFilter = mensajeChatCEN.ReadFilter_MensajeChat("Hola");
                Console.WriteLine($"ReadFilter_MensajeChat('Hola'): {msgFilter.Count()} resultados");
                var msgById = mensajeChatCEN.ReadOID_MensajeChat(msg1.IdMensajeChat);
                Console.WriteLine($"ReadOID_MensajeChat: {msgById?.Contenido}");
                msg1.Contenido = "Hola a todos en el equipo!";
                mensajeChatCEN.ModifyMensajeChat(msg1);
                Console.WriteLine($"ModifyMensajeChat: contenido actualizado");

                // ====== NOTIFICACION ======
                Console.WriteLine("\n--- NotificacionCEN ---");
                var not1 = notificacionCEN.NewNotificacion(u1, "Tienes un nuevo mensaje");
                var not2 = notificacionCEN.NewNotificacion(u2, "Nuevo comentario en tu publicacion");
                Console.WriteLine($"Notificaciones creadas: {not1.IdNotificacion}, {not2.IdNotificacion}");
                
                var allNots = notificacionCEN.ReadAll_Notificacion();
                Console.WriteLine($"ReadAll_Notificacion: {allNots.Count()} notificaciones");
                var notFilter = notificacionCEN.ReadFilter_Notificacion("mensaje");
                Console.WriteLine($"ReadFilter_Notificacion('mensaje'): {notFilter.Count()} resultados");
                var notById = notificacionCEN.ReadOID_Notificacion(not1.IdNotificacion);
                Console.WriteLine($"ReadOID_Notificacion: {notById?.Mensaje}");
                not1.Leida = true;
                notificacionCEN.ModifyNotificacion(not1);
                Console.WriteLine($"ModifyNotificacion: leida actualizada a {not1.Leida}");

                // ====== SESION ======
                Console.WriteLine("\n--- SesionCEN ---");
                var ses1 = sesionCEN.NewSesion(u1, "token-alice-12345");
                var ses2 = sesionCEN.NewSesion(u2, "token-bob-67890");
                Console.WriteLine($"Sesiones creadas: {ses1.IdSesion}, {ses2.IdSesion}");
                
                var allSess = sesionCEN.ReadAll_Sesion();
                Console.WriteLine($"ReadAll_Sesion: {allSess.Count()} sesiones");
                var sesFilter = sesionCEN.ReadFilter_Sesion("token-alice");
                Console.WriteLine($"ReadFilter_Sesion('token-alice'): {sesFilter.Count()} resultados");
                var sesById = sesionCEN.ReadOID_Sesion(ses1.IdSesion);
                Console.WriteLine($"ReadOID_Sesion: {sesById?.Token}");
                ses1.FechaExpiracion = DateTime.UtcNow.AddDays(7);
                sesionCEN.ModifySesion(ses1);
                Console.WriteLine($"ModifySesion: fecha expiracion actualizada");

                // ====== SOLICITUDINGRESO ======
                Console.WriteLine("\n--- SolicitudIngresoCEN ---");
                var sol1 = solicitudCEN.NewSolicitudIngreso(u3, com1, "Quiero unirme a Gamers");
                var sol2 = solicitudCEN.NewSolicitudIngreso(u1, eq2, "Solicito entrar a TeamBeta");
                Console.WriteLine($"SolicitudesIngreso creadas: {sol1.IdSolicitudIngreso}, {sol2.IdSolicitudIngreso}");
                
                var allSols = solicitudCEN.ReadAll_SolicitudIngreso();
                Console.WriteLine($"ReadAll_SolicitudIngreso: {allSols.Count()} solicitudes");
                var solFilter = solicitudCEN.ReadFilter_SolicitudIngreso("Gamers");
                Console.WriteLine($"ReadFilter_SolicitudIngreso('Gamers'): {solFilter.Count()} resultados");
                var solById = solicitudCEN.ReadOID_SolicitudIngreso(sol1.IdSolicitudIngreso);
                Console.WriteLine($"ReadOID_SolicitudIngreso: {solById?.Mensaje}");
                sol1.Estado = ApplicationCore.Domain.Enums.EstadoSolicitud.ACEPTADA;
                solicitudCEN.ModifySolicitudIngreso(sol1);
                Console.WriteLine($"ModifySolicitudIngreso: estado actualizado a {sol1.Estado}");

                // ====== CPs (CASOS DE USO) ======
                Console.WriteLine("\n--- CrearComunidadCP ---");
                var comCP = crearComunidadCP.Ejecutar("Comunidad creada por CP", "Descripcion del CP");
                Console.WriteLine($"CrearComunidadCP.Ejecutar: comunidad {comCP.IdComunidad} creada");

                Console.WriteLine("\n--- UnirEquipoCP ---");
                var miembroCP = unirEquipoCP.Ejecutar(u3.IdUsuario, eq1, ApplicationCore.Domain.Enums.RolEquipo.MIEMBRO);
                Console.WriteLine($"UnirEquipoCP.Ejecutar: miembro {miembroCP.IdMiembroEquipo} creado");

                Console.WriteLine("\n--- AceptarInvitacionCP ---");
                var inv3 = invitacionCEN.NewInvitacion(u3, null, "Invitacion equipo");
                inv3.Tipo = ApplicationCore.Domain.Enums.TipoInvitacion.EQUIPO;
                inv3.Equipo = eq2;
                inv3.Destinatario = u3;
                var miembroAceptado = aceptarInvitacionCP.Ejecutar(inv3);
                Console.WriteLine($"AceptarInvitacionCP.Ejecutar: miembro {miembroAceptado.IdMiembroEquipo} creado por aceptacion de invitacion");

                Console.WriteLine("\n--- AprobarPropuestaTorneoCP ---");
                // Crear propuesta con votos unanimes
                var propCP = propuestaCEN.NewPropuestaTorneo(eq1, torneo1, u1);
                votoCEN.NewVotoTorneo(propCP, u1, true);
                votoCEN.NewVotoTorneo(propCP, u2, true);
                votoCEN.NewVotoTorneo(propCP, u3, true);
                var aprobadoCP = aprobarPropuestaTorneoCP.Ejecutar(propCP);
                Console.WriteLine($"AprobarPropuestaTorneoCP.Ejecutar: {(aprobadoCP ? "APROBADO" : "NO APROBADO")}");

                // ====== DESTRUCCIONES (CLEANUP) ======
                Console.WriteLine("\n--- Destrucciones ---");
                try { comentarioCEN.DestroyComentario(com_c1.IdComentario); Console.WriteLine("DestroyComentario: OK"); } catch { }
                try { publicacionCEN.DestroyPublicacion(pub1.IdPublicacion); Console.WriteLine("DestroyPublicacion: OK"); } catch { }
                try { reaccionCEN.DestroyReaccion(reac1.IdReaccion); Console.WriteLine("DestroyReaccion: OK"); } catch { }
                try { perfilJuegoCEN.DestroyPerfilJuego(perfilJuego1.IdPerfilJuego); Console.WriteLine("DestroyPerfilJuego: OK"); } catch { }
                try { perfilCEN.DestroyPerfil(perfil1.IdPerfil); Console.WriteLine("DestroyPerfil: OK"); } catch { }
                try { juegoCEN.DestroyJuego(juego1.IdJuego); Console.WriteLine("DestroyJuego: OK"); } catch { }
                try { participacionCEN.DestroyParticipacionTorneo(participacion1.IdParticipacionTorneo); Console.WriteLine("DestroyParticipacionTorneo: OK"); } catch { }
                try { votoCEN.DestroyVotoTorneo(voto1.IdVotoTorneo); Console.WriteLine("DestroyVotoTorneo: OK"); } catch { }
                try { propuestaCEN.DestroyPropuestaTorneo(propuesta1.IdPropuestaTorneo); Console.WriteLine("DestroyPropuestaTorneo: OK"); } catch { }
                try { torneoRepo.Destroy(torneo1.IdTorneo); Console.WriteLine("DestroyTorneo (repo): OK"); } catch { }
                try { miembroComunidadCEN.DestroyMiembroComunidad(miembroCom1.IdMiembroComunidad); Console.WriteLine("DestroyMiembroComunidad: OK"); } catch { }
                try { miembroEquipoCEN.DestroyMiembroEquipo(miembroEq1.IdMiembroEquipo); Console.WriteLine("DestroyMiembroEquipo: OK"); } catch { }
                try { invitacionCEN.DestroyInvitacion(inv1.IdInvitacion); Console.WriteLine("DestroyInvitacion: OK"); } catch { }
                try { mensajeChatCEN.DestroyMensajeChat(msg1.IdMensajeChat); Console.WriteLine("DestroyMensajeChat: OK"); } catch { }
                try { notificacionCEN.DestroyNotificacion(not1.IdNotificacion); Console.WriteLine("DestroyNotificacion: OK"); } catch { }
                try { sesionCEN.DestroySesion(ses1.IdSesion); Console.WriteLine("DestroySesion: OK"); } catch { }
                try { solicitudCEN.DestroySolicitudIngreso(sol1.IdSolicitudIngreso); Console.WriteLine("DestroySolicitudIngreso: OK"); } catch { }
                try { chatEquipoCEN.DestroyChatEquipo(chat1.IdChatEquipo); Console.WriteLine("DestroyChatEquipo: OK"); } catch { }
                try { equipoCEN.DestroyEquipo(eq1.IdEquipo); Console.WriteLine("DestroyEquipo: OK"); } catch { }
                try { comunidadCEN.DestroyComunidad(com1.IdComunidad); Console.WriteLine("DestroyComunidad: OK"); } catch { }
                try { usuarioCEN.DestroyUsuario(u1.IdUsuario); Console.WriteLine("DestroyUsuario(alice): OK"); } catch { }
                try { usuarioCEN.DestroyUsuario(u2.IdUsuario); Console.WriteLine("DestroyUsuario(bob): OK"); } catch { }
                try { usuarioCEN.DestroyUsuario(u3.IdUsuario); Console.WriteLine("DestroyUsuario(charlie): OK"); } catch { }

                Console.WriteLine("\n=== TODAS LAS ENTIDADES CREADAS Y METODOS DE LOGICA DE NEGOCIO INVOCADOS CON EXITO ===");
                Console.WriteLine("In-memory comprehensive seeding and CEN/CP smoke tests completed.\n");
                return 0;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"InitializeDbService failed: {ex.Message}");
            return 4;
        }
    }
}
