@using System.Linq
@inject NeuralPlay.Services.IUsuarioAuth UsuarioAuth
@inject ApplicationCore.Domain.CEN.NotificacionCEN NotificacionCEN

<style>
    @@font-face {
        font-family: 'Neue';
        src: url('/Recursos/NeuePower-Ultra.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
    }

    :root {
        --np-red: #e50a46;
    }

    .sidebar-left {
        position: fixed;
        left: 0;
        top: 0;
        width: 11%;
        min-width: 120px;
        height: 100vh;
        background: #e50a46;
        box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 40px;
        z-index: 100;
        justify-content: space-between;
        padding-bottom: 40px;
    }

    .sidebar-logo {
        width: 80%;
        max-width: 150px;
        margin-bottom: 10px;
        >img {
            width: 100%;
            height: auto;
        }
    }

    .sidebar-divider {
        width: 70%;
        height: 2px;
        background-color: white;
        margin-bottom: 30px;
    }

    .sidebar-link {
        color: #fff;
        background: none;
        border: none;
        font-family: 'Neue', sans-serif;
        text-decoration: none;
        letter-spacing: 1px;
        transition: transform 0.3s ease;
    }

    .sidebar-link:hover {
        transform: scale(1.1);
        color: #fff;
    }

    .sidebar-link.active {
        color: var(--np-red, #e50a46);
        background: var(--np-dark-grey, #242424);
        padding: 10px 0;
        margin: 0 -20px 35px -20px;
        padding-left: 20px;
        padding-right: 20px;
        transform: none;
    }

    .sidebar-link-main {
        font-size: 1.3rem;
        margin-bottom: 50px;
    }

    .sidebar-link-secondary {
        font-size: 0.95rem;
        margin-bottom: 35px;
        padding: 0 20px;
        text-align: left;
        width: 100%;
        box-sizing: border-box;
        word-wrap: break-word;
        line-height: 1.3;
    }

    .sidebar-notification {
        color: #fff;
        position: relative;
        margin-top: 30px;
        text-decoration: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: transform 0.3s ease;
    }

    .sidebar-bottom .sidebar-notification:first-child {
        margin-top: 0;
    }

    .sidebar-notification:hover {
        transform: scale(1.1);
        color: #fff;
    }

    .notification-badge {
        position: absolute;
        top: -5px;
        right: -10px;
        font-size: 0.9rem;
        padding: 0.4em 0.6em;
        background-color: white !important;
        color: #e50a46 !important;
        border: 2px solid white;
    }

    .sidebar-profile-image {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid white;
        transition: transform 0.3s ease;
    }

    .sidebar-notification:hover .sidebar-profile-image {
        transform: scale(1.1);
    }

    .sidebar-top {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    .sidebar-bottom {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    /* Tablet: la barra pasa a top bar y se ajustan tamaños */
    @@media (max-width: 1024px) {
        body { padding-top: 88px; padding-left: 0; }

        .sidebar-left {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 74px;
            min-width: unset;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            box-sizing: border-box;
            z-index: 1100;
        }

        .sidebar-top, .sidebar-bottom {
            flex-direction: row;
            align-items: center;
            width: auto;
            gap: 12px;
        }

        .sidebar-divider { display: none; }
        .sidebar-logo { width: 120px; margin: 0; }
        .sidebar-link-main { margin-bottom: 0; font-size: 1.1rem; }
        .sidebar-link-secondary { margin-bottom: 0; padding: 0 10px; font-size: 0.9rem; width: auto; text-align: center; }
        .sidebar-notification { margin-top: 0; }
        .sidebar-profile-image { width: 60px; height: 60px; }
    }
</style>

<div class="sidebar-left">
    <div class="sidebar-top">
        <a href="/" class="sidebar-logo" ><img src="~/Recursos/LOGO_BLANCO.png" alt="NeuralPlay Logo" /></a>
        <div class="sidebar-divider"></div>
        @{
            var currentController = ViewContext.RouteData.Values["controller"]?.ToString() ?? "";
            var currentAction = ViewContext.RouteData.Values["action"]?.ToString() ?? "";
            var isExplorar = currentController == "Home" || currentController == "" || (currentController == "Home" && currentAction == "Index");
            var isComunidades = currentController == "Comunidad" && currentAction == "MisComunidades";
            var isEquipos = currentController == "Equipos";
            var isCrear = currentController == "Crear";
        }
        <a href="/" class="sidebar-link sidebar-link-main @(isExplorar ? "active" : "")">EXPLORAR</a>
        <a asp-controller="Comunidad" asp-action="MisComunidades" class="sidebar-link sidebar-link-secondary @(isComunidades ? "active" : "")">MIS COMUNIDADES</a>
        <a href="/Equipos" class="sidebar-link sidebar-link-secondary @(isEquipos ? "active" : "")">MIS EQUIPOS</a>
        <a asp-controller="Crear" asp-action="Index" class="sidebar-link sidebar-link-secondary @(isCrear ? "active" : "")">CREAR</a>
    </div>

    <div class="sidebar-bottom">
        @if (UsuarioAuth?.GetUsuarioActual() != null)
    {
        var current = UsuarioAuth.GetUsuarioActual();
        var unread = 0;
        try
        {
            unread = NotificacionCEN.ReadAll_Notificacion().Count(n => n != null && n.Destinatario != null && n.Destinatario.IdUsuario == current!.IdUsuario && !n.Leida);
        }
        catch { unread = 0; }

        <a href="@Url.Action("Index", "Notificacion")" class="sidebar-notification" title="Notificaciones">
            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="currentColor" class="bi bi-bell" viewBox="0 0 16 16" aria-hidden="true">
                <path d="M8 16a2 2 0 0 0 1.985-1.75H6.015A2 2 0 0 0 8 16z"/>
                <path d="M8 1a4 4 0 0 0-4 4v2.086c0 .39-.168.765-.45 1.03L2 10v1h12v-1l-.55-1.884A1.986 1.986 0 0 1 13 7.086V5a4 4 0 0 0-4-4z"/>
            </svg>
            @if (unread > 0)
            {
                <span class="badge bg-danger rounded-pill notification-badge">@unread</span>
            }
        </a>

        @if (current.Perfil != null)
        {
            <a href="@Url.Action("Details", "Perfiles", new { id = current.Perfil.IdPerfil })" class="sidebar-notification" title="Mi Perfil" style="margin-top: 30px;">
                @if (!string.IsNullOrEmpty(current.Perfil.FotoPerfilUrl))
                {
                    <img src="@current.Perfil.FotoPerfilUrl" alt="Mi Perfil" class="sidebar-profile-image" />
                }
                else
                {
                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16" aria-hidden="true">
                        <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                        <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                    </svg>
                }
            </a>
        }
        }
        else
        {
            <a href="@Url.Action("Login", "Usuario")" class="sidebar-link sidebar-link-secondary">INICIAR SESIÓN</a>
        }
    </div>
</div>