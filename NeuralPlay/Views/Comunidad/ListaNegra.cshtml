@model NeuralPlay.Models.ComunidadViewModel

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = $"Lista Negra - {Model.Nombre}";
    var miembrosExpulsados = ViewBag.MiembrosExpulsados as List<NeuralPlay.Models.MiembroComunidadViewModel> ?? new List<NeuralPlay.Models.MiembroComunidadViewModel>();
    ViewBag.OcultarNavbar = true;
}

@Html.Partial("~/Views/Shared/_SidebarLeft.cshtml")
@Html.Partial("~/Views/Shared/_SidebarRight.cshtml")
@Html.Partial("~/Views/Shared/_SidebarDown.cshtml")

<style>
    /* Reset para etiquetas semánticas */
    figure, hgroup, footer, hr, fieldset {
        margin: 0;
        padding: 0;
    }

    fieldset {
        border: none;
        min-width: 0;
    }

    hr {
        border: none;
        height: 2px;
    }

    :root {
        --np-red: #e50a46;
        --np-transp: #21020a7a;
        --np-grey: #454545;
        --np-dark-grey: #242424;
    }

    @@font-face {
        font-family: 'Neue';
        src: url('/Recursos/NeuePower-Ultra.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
    }

    @@font-face {
        font-family: 'Lexend';
        src: url('/Recursos/Lexend-Medium.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
    }

    body {
        margin: 0;
        padding: 0;
        overflow-x: hidden;
    }

    /* Contenedor principal - solo fondo */
    .main-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: url('/Recursos/WALLPAPER_GRIS.png') no-repeat center center fixed;
        background-size: cover;
        z-index: 1;
    }

    /* Contenedor de contenido - entre las barras */
    .content-container {
        position: absolute;
        left: 11%;
        top: 0;
        width: 83%; /* 100% - 11% (izq) - 6% (der) */
        min-height: 100vh;
        z-index: 2;
        padding: 40px;
    }

    .page-header {
        margin-bottom: 40px;
    }

    .page-title {
        font-family: 'Neue', sans-serif;
        font-size: 4rem;
        color: white;
        text-transform: uppercase;
        margin: 0;
        margin-bottom: 10px;
    }

    .page-subtitle {
        font-family: 'Lexend', sans-serif;
        font-size: 1.5rem;
        color: #aaa;
        margin: 0;
        margin-bottom: 30px;
    }

    .btn-back {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: var(--np-red);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-family: 'Lexend', sans-serif;
        font-size: 1rem;
        transition: all 0.3s;
        margin-bottom: 30px;
    }

    .btn-back:hover {
        background: #c4083c;
        color: white;
        transform: translateX(-5px);
    }

    .members-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }

    .member-card {
        background: rgba(36, 36, 36, 0.95);
        border-radius: 10px;
        padding: 25px;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: all 0.3s;
        border: 2px solid #8b0000;
    }

    .member-card:hover {
        border-color: var(--np-red);
        box-shadow: 0 8px 20px rgba(229, 10, 70, 0.3);
    }

    .member-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 3px solid #8b0000;
        flex-shrink: 0;
        overflow: hidden;
        opacity: 0.7;
    }

    .member-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        filter: grayscale(100%);
    }

    .member-avatar-placeholder {
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #8b0000 0%, #5a0000 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Neue', sans-serif;
        font-size: 2rem;
        color: white;
    }

    .member-info {
        flex: 1;
    }

    .member-name {
        font-family: 'Neue', sans-serif;
        font-size: 1.5rem;
        color: white;
        margin: 0 0 5px 0;
        display: block;
    }

    .member-status {
        font-family: 'Lexend', sans-serif;
        font-size: 0.9rem;
        color: #ff4444;
        margin: 0 0 5px 0;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .member-date {
        font-family: 'Lexend', sans-serif;
        font-size: 0.85rem;
        color: #666;
        margin: 0 0 15px 0;
    }

    .btn-permitir {
        background: transparent;
        border: 2px solid #4CAF50;
        color: #4CAF50;
        padding: 8px 16px;
        border-radius: 6px;
        font-family: 'Lexend', sans-serif;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-permitir:hover {
        background: #4CAF50;
        color: white;
        transform: scale(1.05);
    }

    .no-members {
        text-align: center;
        padding: 60px 20px;
        color: #888;
        font-family: 'Lexend', sans-serif;
        font-size: 1.2rem;
        background: rgba(36, 36, 36, 0.7);
        border-radius: 10px;
    }

    .no-members i {
        font-size: 4rem;
        color: #4CAF50;
        margin-bottom: 20px;
        display: block;
    }

    .alert {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-family: 'Lexend', sans-serif;
        display: none;
    }

    .alert-success {
        background: rgba(76, 175, 80, 0.2);
        border: 2px solid #4CAF50;
        color: #4CAF50;
    }

    .alert-error {
        background: rgba(244, 67, 54, 0.2);
        border: 2px solid #f44336;
        color: #f44336;
    }
</style>

<!-- Contenedor principal - solo fondo -->
<div class="main-container"></div>

<!-- Contenedor de contenido - entre las barras laterales -->
<section class="content-container">
    <header class="page-header">
        <a asp-action="Details" asp-route-id="@Model.IdComunidad" class="btn-back">
            <i class="bi bi-arrow-left"></i>
            Volver a la comunidad
        </a>
        
        <h1 class="page-title">Lista Negra</h1>
        <p class="page-subtitle">@Model.Nombre - Usuarios expulsados</p>
    </header>

    <div id="alertMessage" class="alert"></div>

    @if (miembrosExpulsados.Any())
    {
        <section class="members-grid">
            @foreach (var miembro in miembrosExpulsados)
            {
                <article class="member-card" id="member-@miembro.IdMiembroComunidad">
                    <figure class="member-avatar">
                        @if (!string.IsNullOrEmpty(miembro.Avatar))
                        {
                            <img src="@miembro.Avatar" alt="@miembro.NombreUsuario" />
                        }
                        else
                        {
                            <div class="member-avatar-placeholder">
                                @(miembro.NombreUsuario?.Substring(0, 1).ToUpper() ?? "?")
                            </div>
                        }
                    </figure>
                    <div class="member-info">
                        <span class="member-name">@miembro.NombreUsuario</span>
                        <p class="member-status">
                            <i class="bi bi-x-circle-fill"></i>
                            Expulsado
                        </p>
                        <p class="member-date">
                            Expulsado el @(miembro.FechaBaja?.ToString("dd/MM/yyyy") ?? "Fecha desconocida")
                        </p>
                        <button class="btn-permitir" onclick="permitirReingreso(@miembro.IdMiembroComunidad, '@miembro.NombreUsuario')">
                            <i class="bi bi-check-circle"></i>
                            Permitir reingreso
                        </button>
                    </div>
                </article>
            }
        </section>
    }
    else
    {
        <aside class="no-members">
            <i class="bi bi-check-circle"></i>
            <p>No hay usuarios en la lista negra.</p>
            <p style="font-size: 1rem; color: #666; margin-top: 10px;">
                Todos los miembros están en buenos términos con la comunidad.
            </p>
        </aside>
    }
</section>

<script>
    function permitirReingreso(miembroId, nombreUsuario) {
        if (!confirm(`¿Estás seguro de que quieres permitir que ${nombreUsuario} pueda volver a unirse a la comunidad?`)) {
            return;
        }

        fetch('/Comunidad/PermitirReingreso', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `miembroId=${miembroId}`
        })
        .then(response => response.json())
        .then(data => {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.textContent = data.message;
            
            if (data.success) {
                alertDiv.className = 'alert alert-success';
                alertDiv.style.display = 'block';
                
                // Eliminar la tarjeta del miembro de la vista
                const memberCard = document.getElementById(`member-${miembroId}`);
                if (memberCard) {
                    memberCard.style.transition = 'all 0.5s';
                    memberCard.style.opacity = '0';
                    memberCard.style.transform = 'scale(0.8)';
                    setTimeout(() => {
                        memberCard.remove();
                        
                        // Si no quedan más miembros, mostrar mensaje
                        const membersGrid = document.querySelector('.members-grid');
                        if (membersGrid && membersGrid.children.length === 0) {
                            location.reload();
                        }
                    }, 500);
                }

                // Ocultar la alerta después de 3 segundos
                setTimeout(() => {
                    alertDiv.style.display = 'none';
                }, 3000);
            } else {
                alertDiv.className = 'alert alert-error';
                alertDiv.style.display = 'block';
            }
        })
        .catch(error => {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.className = 'alert alert-error';
            alertDiv.textContent = 'Error al procesar la solicitud: ' + error;
            alertDiv.style.display = 'block';
        });
    }
</script>

